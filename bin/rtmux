#!/bin/sh

# rtmux DESTINATION [SESSION]
#
# Copy config files to the directory $HOME/{SESSION} at the remote host given
# by DESTINATION. Then login to the remote host with the the session directory
# set as $HOME, and start or reconnect to a tmux session on the remote host
# using the same session name.
#
# DESTINATION is an ssh target of the form # [user@]hostname
#
# SESSION is an optional argument. If not given, defaults to local username.

set -e
set -x

DESTINATION="${1}"
SESSION="${2:-${USER}}"
local_tmp="$(mktemp --tmpdir --directory home.XXXXXXXX)"
remote_home="$(ssh ${DESTINATION} printenv HOME)/${USER}"

chmod 755 "${local_tmp}"

for f in .bash_profile .bashrc .bash .gitconfig .hgrc .inputrc .profile .screenrc .tmux.conf .vim .vimrc static; do
    ln -sT "${HOME}/${f}" "${local_tmp}/${f}"
done

bin="${local_tmp}/bin"
mkdir "${bin}"

my_tmux="${bin}/my-tmux"
cat << HERE > "${my_tmux}"
#!/bin/sh
export REAL_HOME="\${HOME}"
export HOME="${remote_home}"
if [ ! -e "\${HOME}/.ssh" ]; then
    ln -sT "\${REAL_HOME}/.ssh" "\${HOME}/.ssh"
fi
if command -V tmux > /dev/null 2>&1; then
    tmux=tmux
else
    ln -sT "\${HOME}/static/tmux/bin/tmux" "\${HOME}/bin/tmux"
    tmux="\${HOME}/bin/tmux"
fi
cd "\${HOME}"
exec \${tmux} new-session -A -s "${SESSION}"
HERE
chmod +x "${my_tmux}"

rsync --archive --copy-links "${local_tmp}/" "${DESTINATION}:${remote_home}"
rm --recursive --force "${local_tmp}"

remote_command="${remote_home}/bin/my-tmux"
if mosh "${DESTINATION}" "${remote_command}"; then
    exit
else
    ssh -t "${DESTINATION}" "${remote_command}" 
fi
